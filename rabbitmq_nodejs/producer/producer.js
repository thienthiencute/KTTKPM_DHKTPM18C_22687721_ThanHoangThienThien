const express = require("express");
const amqp = require("amqplib");

const app = express();
app.use(express.json());

const RABBITMQ_URL = "amqp://user:password@rabbitmq:5672";
const QUEUE = "order_queue";

let channel;

async function connectRabbitMQ() {
  while (true) {
    try {
      const conn = await amqp.connect(RABBITMQ_URL);
      channel = await conn.createChannel();
      await channel.assertQueue(QUEUE, { durable: true });

      console.log("Producer connected to RabbitMQ");
      break;
    } catch (err) {
      console.log("Waiting for RabbitMQ...");
      await new Promise((r) => setTimeout(r, 3000));
    }
  }
}

app.post("/send", (req, res) => {
  if (!channel) {
    return res.status(503).json({ error: "RabbitMQ not ready" });
  }

  const { message, orderId } = req.body;

  if (!message) {
    return res.status(400).json({ error: "message is required" });
  }

  const data = {
    orderId,
    message,
    timestamp: new Date()
  };

  channel.sendToQueue(
    QUEUE,
    Buffer.from(JSON.stringify(data)),
    { persistent: true }
  );

  console.log("Sent:", data);

  res.json({
    status: "sent",
    dataSent: data
  });
});

connectRabbitMQ();

app.listen(3000, () => {
  console.log("Producer API listening on port 3000");
});
